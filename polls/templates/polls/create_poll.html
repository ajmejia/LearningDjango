{% extends "base_template.html" %}
{% load staticfiles %}

{% block add_styles %}
	<link rel="stylesheet" type="text/css" href="{% static 'polls/css/form_style.css' %}">
{% endblock %}

{% block flash_messages_block %}
	{% with flash_messages=messages %}
		{% for message in flash_messages %}
			<div class="{{ message.tags }}">{{ message }}</div>
		{% endfor %}
	{% endwith %}
{% endblock %}

{% block page_title %}Create your poll{% endblock %}

{% block page_body %}
	{% with flash_messages=question_form.non_field_errors|add:choice_forms.non_form_errors %}
		{% for message in flash_messages %}
			<div class="error">{{ message }}</div>
		{% endfor %}
	{% endwith %}
	<form action="{% url 'polls:create-poll' %}" method="post">
		{% csrf_token %}
		<div class="field-wrapper">
			<label for="{{ question_form.question.label }}">{{ question_form.question.label }}</label>
			{{ question_form.question }}
			<div class="error-field">
				{{ question_form.question.errors }}
			</div>
		</div>
		<div id="formset-placeholder">
			{{ choice_forms.management_form }}
			<label>Choices</label>
			<input type="button" class="add-form-row" value="add">
			{% for choice_form in choice_forms.forms %}
				<div class="dynamic-form">
						<input type="button" class="delete-form-row" value="delete">
						{{ choice_form.option }}
						<div class="error-field">
							{{ choice_form.option.errors }}
						</div>
				</div>
			{% endfor %}
		</div>
		<input type="submit" value="Create"/>
	</form>
{% endblock %}

{% block js %}
	<script>
		(function() {
		  var formsetChoice = {
		    init: function() {
		      this.cacheDom();
		      this.bindEvents();
		    },
		    cacheDom: function(){
		      this.formsetSelector = "#formset-placeholder";
		      this.choiceSelector = ".dynamic-form";
		      this.addSelector = ".add-form-row";
		      this.delSelector = ".delete-form-row";
		      
		      this.$choicesPlaceHolder = $(this.formsetSelector);
		      // find add button
		      this.$addButton = this.$choicesPlaceHolder.find(this.addSelector);
		      // find delete buttons
		      this.$delButton = this.$choicesPlaceHolder.find(this.delSelector);
		      // find TOTAL_NUM_FORMS
		      this.totalChoices = Number(this.$choicesPlaceHolder.find("#id_form-TOTAL_FORMS").val());
		      // find MIN_NUM_FORMS
		      this.minChoices = Number(this.$choicesPlaceHolder.find("#id_form-MIN_NUM_FORMS").val());
		      // find MAX_NUM_FORMS
		      this.maxChoices = Number(this.$choicesPlaceHolder.find("#id_form-MAX_NUM_FORMS").val());
		      // last sibling
		      this.$lastSibling = this.$choicesPlaceHolder.find(this.choiceSelector + ":last");
		      // empty form
		      this.$emptyForm = this.$lastSibling.clone(true)
		      this.$emptyForm.find("input").removeAttr("checked")
		        .removeAttr("selected")
		        .not(":button, :submit, :reset, [type='hidden'], :radio, :checkbox")
		        .val("")
		        .attr("value", ""); // Handle UpdateView default values
		    },
		    bindEvents: function() {
		    // on click add
		      this.$addButton.on("click", this.addForm.bind(this));
		    // on click delete
		      this.$choicesPlaceHolder.delegate(this.choiceSelector, "click", this.delForm.bind(this));
		    },
		    updForm: function() {
		      var $fields = this.$choicesPlaceHolder.find("input[type='text']");
		      
		      for(var i = 0; i < $fields.length; i++) {
		        var field = $fields.get(i);
		        $(field).attr("id", "id_form-" + i + "-option");
		        $(field).attr("name", "form-" + i + "-option");
		      }
		    },
		    // DEFINE LISTENERS -----------------------------------------
		    addForm: function() {
		      var $newSibling = this.$emptyForm.clone(true);
		    //   add new choice field
		      $newSibling.insertAfter(this.$lastSibling);
		    //   update
		      this.$lastSibling = this.$choicesPlaceHolder.find(this.choiceSelector + ":last");
		      ++this.totalChoices;
		      this.updForm();
		    },
		    delForm: function(event) {
		    //   delete choice field
		      this.$choicesPlaceHolder.find(event.target).closest(this.choiceSelector).remove();
		    //   update
		      if(this.$choicesPlaceHolder.find(this.choiceSelector).length > 0)
		        this.$lastSibling = this.$choicesPlaceHolder.find(this.choiceSelector + ":last");
		      else
		        this.$lastSibling = this.$choicesPlaceHolder.find(":last-child");
		      --this.totalChoices;
		      this.updForm();
		    },
		  };
		  formsetChoice.init();
		})()
	</script>
{% endblock %}
